<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Test Results</title>

  <!-- Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --blue: #007adf;
      --light: #56b4ef;
      --green: #28a745;
      --red: #dc3545;
      --yellow: #ffc107;
      --bg: #f5f8fa;
      --card-radius: 8px;
      --font: "Poppins", sans-serif;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: #333;
      line-height: 1.4;
      padding-bottom: 40px;
    }
    .top-container {
      background: #fff;
      padding: 16px;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      position: sticky; top:0; z-index:10;
    }
    .top-container h1 {
      font-size: 18px; font-weight:600;
      color: var(--blue);
    }
    .top-container .info {
      font-size: 0.9rem; color: #555;
      margin-top: 4px;
    }
    .container {
      max-width: 880px; margin:20px auto; padding:0 16px;
    }
    /* Metrics */
    #totalResult {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:16px; margin:24px 0;
    }
    .metric-card {
      background:#fff; border-radius:var(--card-radius);
      padding:14px; text-align:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
      transition:transform .2s;
    }
    .metric-card:hover { transform:translateY(-4px); }
    .metric-card.correct { border-left:4px solid var(--green); }
    .metric-card.wrong   { border-left:4px solid var(--red); }
    .metric-card.unans   { border-left:4px solid var(--yellow); }
    .metric-card.score   { border-left:4px solid var(--blue); }
    .metric-card.percent { border-left:4px solid var(--light); }
    .metric-card.accuracy{ border-left:4px solid var(--green); }
    .metric-card.completed{border-left:4px solid var(--blue);}
    .metric-card h2 {
      font-size:1.6rem; margin:6px 0; color:var(--blue);
    }
    .metric-card p {
      font-size:0.85rem; color:#666;
    }
    /* Doughnut + legend */
    .info-card {
      display:flex; align-items:center; justify-content:space-between;
      background:#fff; padding:16px; border-radius:var(--card-radius);
      box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:24px;
    }
    .info-left h3 { margin-bottom:8px; color:var(--blue); font-weight:600; }
    .legend { display:flex; gap:12px; }
    .legend-item { display:flex; align-items:center; font-size:0.85rem; color:#444; }
    .legend-color {
      width:12px; height:12px; border-radius:2px; margin-right:6px;
    }
    .legend-color.green  { background:var(--green); }
    .legend-color.red    { background:var(--red); }
    .legend-color.yellow { background:var(--yellow); }
    .info-right { width:100px; height:100px; }
    /* Tabs */
    #buttonsContainer {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
      margin-bottom:24px;
    }
    #buttonsContainer button {
      padding:6px 14px; border:2px solid var(--light);
      border-radius:20px; background:#fff; color:#555;
      font-size:0.85rem; cursor:pointer; transition:background .2s,color .2s;
    }
    #buttonsContainer button.active-button,
    #buttonsContainer button:hover {
      background:var(--light); color:#fff; border-color:var(--light);
    }
    /* Questions */
    .question-box {
      background:#fff; border-radius:var(--card-radius);
      box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:24px;
      overflow:hidden;
    }
    .question-header {
      background:var(--light); color:#fff; padding:10px 14px;
      font-size:0.9rem; position:relative;
    }
    .question-header::after {
      content:""; position:absolute; bottom:0; left:0;
      height:3px; width:var(--progress,0%); background:var(--green);
      transition:width .2s;
    }
    .question-body { padding:14px; }
    .options { list-style:none; margin-bottom:12px; padding:0; }
    .option-box {
      background:#fafafa; padding:8px 12px; margin:6px 0;
      border-radius:4px; border:1px solid #ececec;
      font-size:0.9rem; transition:border-color .2s;
    }
    .option-box.correct {
      border-color:var(--green); background:#e9f7ec; color:var(--green);
    }
    .feedback {
      display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;
    }
    .feedback span {
      flex:1 1 45%; padding:6px 10px; border-radius:4px;
      font-size:0.85rem; text-align:center; font-weight:500;
    }
    .selected-correct { background:var(--green); color:#fff; }
    .selected-wrong   { background:var(--red);   color:#fff; }
    .correct-answer   { background:#e9f7ec; color:var(--green); }
    .solution {
      background:#f1f1f1; padding:10px 12px;
      border-left:4px solid var(--blue); font-size:0.85rem;
      color:#444; font-style:italic;
    }
    /* Pager */
    .pager {
      display:flex; justify-content:space-between; margin:24px 0;
    }
    .pager button {
      padding:6px 12px; background:var(--blue);
      color:#fff; border:none; border-radius:4px;
      font-size:0.9rem; cursor:pointer;
    }
    .pager button:disabled { opacity:0.5; cursor:not-allowed; }
    /* Section table */
    .section-table {
      width:100%; border-collapse:collapse; margin-top:32px;
    }
    .section-table th,
    .section-table td {
      border:1px solid #ddd; padding:8px; font-size:0.85rem;
      text-align:center;
    }
    .section-table th {
      background:var(--light); color:#fff;
    }
    @media (max-width:600px) {
      .info-card { flex-direction:column; align-items:flex-start; }
      .info-right { margin-top:12px; }
    }
  </style>
</head>
<body>

  <div class="top-container">
    <h1>Practice Test 01</h1>
    <div class="info">75 Questions • 300 Marks • 180 mins  &nbsp;|&nbsp; Attempted on 11 May 2025</div>
  </div>

  <div class="container">
    <!-- Metrics -->
    <div id="totalResult"></div>

    <!-- Doughnut + Legend -->
    <div class="info-card">
      <div class="info-left">
        <h3>Overall Analysis</h3>
        <div class="legend">
          <div class="legend-item"><div class="legend-color green"></div>Correct</div>
          <div class="legend-item"><div class="legend-color red"></div>Wrong</div>
          <div class="legend-item"><div class="legend-color yellow"></div>Unanswered</div>
        </div>
      </div>
      <div class="info-right">
        <canvas id="overallChart"></canvas>
      </div>
    </div>

    <!-- Tabs -->
    <div id="buttonsContainer"></div>

    <!-- Questions -->
    <div id="sectionResult">
      <p style="text-align:center;color:#777;">Select a subject to begin.</p>
    </div>

    <!-- Section-Wise Table -->
    <h3 style="margin-top:32px;color:var(--blue);">Section-Wise Performance</h3>
    <table class="section-table" id="sectionTable">
      <thead>
        <tr>
          <th>Section</th><th>Score</th><th>Correct</th>
          <th>Wrong</th><th>Unanswered</th>
          <th>Accuracy</th><th>Time Taken</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:    "AIzaSyDOYPyulIXHzVhse8xWfpXoCBOkE3VSHts",
      authDomain:"brainiacs-13a3f.firebaseapp.com",
      projectId: "brainiacs-13a3f",
      storageBucket:"brainiacs-13a3f.firebasestorage.app",
      messagingSenderId:"530382354851",
      appId:      "1:530382354851:web:f65bde4a1b3f86d75d8216"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const params    = new URLSearchParams(window.location.search);
    const testID    = params.get("test")    || alert("Test ID missing!");
    const batchName = params.get("batch")   || alert("Batch missing!");
    const username  = params.get("username")|| alert("Username missing!");

    function formatTextWithImages(text) {
      return text?.replace(
        /(https?:\/\/[^\s]+)/g,
        url => `<img src="${url}" style="max-width:100%;border-radius:4px;margin-top:4px;">`
      ) || "–";
    }

    async function loadTestStructure() {
      const snap = await getDoc(doc(db,"Questions",testID));
      if (!snap.exists()) throw new Error("Test structure not found");
      return snap.data().subjects || [];
    }

    async function loadUserResponses() {
      const u = await getDoc(doc(db,"Tests",testID,"Batches",batchName,"Users",username));
      if (!u.exists()) throw new Error("No submission for this user");
      return u.data(); // { subjects: {...}, percentile?, ... }
    }

    async function fetchSubjectQuestions(subj){
      const s = await getDoc(doc(db,"Questions",testID,"Subjects",subj));
      return s.exists() ? Object.values(s.data().questions||{}) : [];
    }

    function drawDoughnut(id,data){
      new Chart(document.getElementById(id),{
        type:"doughnut",
        data:{ labels:["Correct","Wrong","Unanswered"], datasets:[{ data, backgroundColor:[ "--green","--red","--yellow" ].map(c=>getComputedStyle(document.documentElement).getPropertyValue(c)) }]},
        options:{ plugins:{ legend:{display:false} }, cutout:"60%" }
      });
    }

    async function displayResults(){
      const subjects = await loadTestStructure();
      const userData = await loadUserResponses();
      const userResp = userData.subjects || {};

      let totalC=0,totalW=0,totalU=0,totalScore=0;
      const perSub={};

      for(let subj of subjects){
        const qs = await fetchSubjectQuestions(subj);
        let c=0,w=0,u=0;
        const details = qs.map(q=>{
          const sel=(userResp[subj]?.[q.questionId]?.selectedAnswer||"").trim().toUpperCase();
          const corr=(q.correctAnswer||"").trim().toUpperCase();
          if(!sel) u++;
          else if(sel===corr){ c++; totalScore+=4; }
          else { w++; totalScore-=1; }
          return { q, sel, corr };
        });
        totalC+=c; totalW+=w; totalU+=u;
        perSub[subj]={ details, timeTaken:userResp[subj]?.timeTaken||"–" };
      }

      const totalQ=totalC+totalW+totalU;
      const acc = totalQ ? totalC/totalQ*100 : 0;
      const pct = userData.percentile ?? acc;
      const comp = totalQ ? (totalC+totalW)/totalQ*100 : 0;

      document.getElementById("totalResult").innerHTML=`
        <div class="metric-card correct"><h2>${totalC}</h2><p>Correct</p></div>
        <div class="metric-card wrong"><h2>${totalW}</h2><p>Wrong</p></div>
        <div class="metric-card unans"><h2>${totalU}</h2><p>Unanswered</p></div>
        <div class="metric-card score"><h2>${totalScore}</h2><p>Score</p></div>
        <div class="metric-card percent"><h2>${pct.toFixed(2)}%</h2><p>Percentile</p></div>
        <div class="metric-card accuracy"><h2>${acc.toFixed(2)}%</h2><p>Accuracy</p></div>
        <div class="metric-card completed"><h2>${comp.toFixed(2)}%</h2><p>Completed</p></div>
      `;

      drawDoughnut("overallChart",[totalC,totalW,totalU]);

      const bc=document.getElementById("buttonsContainer");
      bc.innerHTML="";
      subjects.forEach(subj=>{
        const btn=document.createElement("button");
        btn.textContent=subj;
        btn.onclick=()=>showSubject(subj,btn);
        bc.append(btn);
      });
      bc.firstChild?.click();

      // fill table
      document.querySelector("#sectionTable tbody").innerHTML=
        subjects.map(subj=>{
          const d=perSub[subj], tot=d.details.length;
          const c=d.details.filter(x=>x.sel===x.corr).length;
          const w=d.details.filter(x=>x.sel&&x.sel!==x.corr).length;
          const u=tot-c-w;
          return `<tr>
            <td>${subj}</td><td>${c*4 - w}</td><td>${c}</td>
            <td>${w}</td><td>${u}</td>
            <td>${tot? (c/tot*100).toFixed(2):"0.00"}%</td>
            <td>${d.timeTaken}</td>
          </tr>`;
        }).join("");

      function showSubject(subj,btn){
        bc.querySelectorAll("button").forEach(b=>b.classList.remove("active-button"));
        btn.classList.add("active-button");
        const details=perSub[subj].details;
        let idx=0;
        document.getElementById("sectionResult").innerHTML=`
          <div id="questionContainer"></div>
          <div class="pager">
            <button id="prevBtn">Previous</button>
            <button id="nextBtn">Next</button>
          </div>
        `;
        const qCont=document.getElementById("questionContainer");
        const pBtn=document.getElementById("prevBtn");
        const nBtn=document.getElementById("nextBtn");
        function render(i){
          const { q, sel, corr }=details[i];
          const pr=Math.round((i+1)/details.length*100);
          qCont.innerHTML=`
            <div class="question-box">
              <div class="question-header" style="--progress:${pr}%">
                Q${i+1}/${details.length}: ${formatTextWithImages(q.question)}
              </div>
              <div class="question-body">
                <ul class="options">
                  ${(q.options||[]).map(o=>
                    `<li class="option-box${o.trim().toUpperCase()===corr?" correct":""}">
                      ${formatTextWithImages(o)}
                    </li>`).join("")}
                </ul>
                <div class="feedback">
                  <span class="${sel===corr?'selected-correct':'selected-wrong'}">
                    Your: ${sel||'–'}</span>
                  ${sel===corr?"":`<span class="correct-answer">Ans: ${corr}</span>`}
                </div>
                <div class="solution">
                  <strong>Solution:</strong> ${formatTextWithImages(q.solution)}
                </div>
              </div>
            </div>`;
          pBtn.disabled = i===0;
          nBtn.disabled = i===details.length-1;
        }
        pBtn.onclick = ()=> idx>0 && render(--idx);
        nBtn.onclick = ()=> idx<details.length-1 && render(++idx);
        render(idx);
      }
    }

    window.onload = ()=>displayResults().catch(e=>{
      document.getElementById("sectionResult").innerHTML =
        `<p style="color:red;text-align:center;">${e.message}</p>`;
      console.error(e);
    });
  </script>

</body>
</html>
